# etf-strategy----鱼盆ETF投资量化模型
项目说明:

所有文件放在根目录，简化导入关系

2025-08-20-Ver1.0【增加聚宽数据源只有三个月试用期】

【数据爬取模块说明】
  本文件同时负责从多个数据源获取ETF数据和新股信息
  
  主数据源：AkShare
  
  备用数据源：Baostock、新浪财经，聚宽

【策略详细说明 - 数据获取逻辑】
1. ETF数据获取流程：
   - 主数据源：AkShare（优先尝试，返回最完整数据）
   - 备用数据源1：Baostock（当AkShare失败时尝试）
   - 备用数据源2：新浪财经（当前两个数据源都失败时尝试）
   - 备用数据源3：聚宽（当前三个数据源都失败时尝试）
   - 缓存机制：优先检查本地缓存，减少API调用次数

2. 新股信息获取逻辑：
   - 区分两种新股类型：
     * 认购新股（IPO申购）：通过"网上申购日"筛选
     * 上市交易新股：通过"上市日期"筛选
   - 历史数据范围：过去30天（原为7天），确保覆盖最近上市交易的新股
   - 多数据源回退机制：确保即使主数据源失败也能获取数据

3. 数据质量保障：
   - 严格的数据验证：检查DataFrame是否为空
   - 完善的错误处理：记录详细错误日志
   - 数据类型转换：确保数值型字段为正确类型
   - 日期格式标准化：统一使用YYYY-MM-DD格式

4. 性能优化：
   - 缓存机制：减少重复API调用
   - 限流控制：每个API调用间隔1秒
   - 数据过滤：仅获取必要字段

【异常处理机制】
1. 数据源失败：
   - 记录详细错误日志，包含错误类型和消息
   - 自动切换到备用数据源
   - 所有数据源失败时返回空DataFrame

2. 数据质量异常：
   - 空数据处理：返回空DataFrame而非抛出异常
   - 字段缺失处理：使用默认值填充
   - 类型转换错误：记录日志并跳过该条数据

3. 网络问题：
   - 设置15秒超时
   - 重试机制（最多3次）
   - 失败后等待30分钟再重试

【使用说明】
1. 获取ETF数据：get_etf_data(etf_code, data_type='daily')
2. 获取ETF列表：get_all_etf_list()
3. 获取新股信息：get_new_stock_subscriptions()
4. 测试用新股数据获取：get_test_new_stock_subscriptions()
5. 测试用新上市股数据获取：get_test_new_stock_listings()

【数据存储模块说明】
  本文件同时负责数据的存储和清理
  所有文件放在根目录，简化导入关系

【时间处理工具说明】
  本文件同时提供时间相关的工具函数
  所有文件放在根目录，简化导入关系

【企业微信集成说明】
  本文件同时处理企业微信消息推送
  所有文件放在根目录，简化导入关系

【股票池管理模块说明】
  本文件同时负责ETF股票池的更新和管理
  保持10只ETF：5只稳健仓，5只激进仓
  所有文件放在根目录，简化导入关系

【策略计算模块说明】
  本文件负责ETF策略信号的计算和推送
  所有文件放在根目录，简化导入关系

【评分系统核心模块】
  本文件同时包含ETF评分计算功能，为其他模块提供统一的评分接口
  所有文件放在根目录，简化导入关系

【策略详细说明 - 评分体系】
1. 评分维度与权重分配：
   - 流动性评分（20%）：评估ETF交易活跃度，由日均成交额和规模决定
     * 日均成交额（12%）：越高分越高，10亿以上得满分
     * 规模（8%）：越大分越高，500亿以上得满分
     * 目的：确保ETF有足够流动性，避免买卖困难

2. 风险控制评分（25%）：评估ETF风险水平，由波动率和最大回撤决定
   - 年化波动率（15%）：越低分越高，<15%得满分
   - 最大回撤（10%）：越小分越高，<20%得满分
   * 目的：稳健仓特别关注风险控制，避免大幅波动

3. 收益能力评分（25%）：评估ETF历史收益表现
   - 1年收益率（10%）：越高分越高，>10%得满分
   - 3年年化收益率（10%）：越高分越高，>8%得满分
   - 夏普比率（5%）：越高分越高，>1.0得满分
   * 目的：衡量风险调整后收益，避免高风险高收益

4. 溢价率评分（15%）：评估ETF市场价格与净值关系
   - 溢价率（10%）：越接近0%越好，-1%~1%得满分
   - 适度溢价加分（5%）：0.5%~1.5%额外加分
   * 目的：避免在高溢价时买入，防止套利压力

5. 情绪指标评分（15%）：评估市场情绪和成分股质量
   - 龙头股占比（9%）：前5大成分股权重和，越高分越高
   - 行业分散度（6%）：行业数量越多分越高，避免过度集中
   * 目的：捕捉市场情绪和行业轮动机会

【股票池构建逻辑】
1. 筛选过程：
   - 步骤1：获取所有ETF列表（约50只）
   - 步骤2：计算每只ETF的5个维度评分（0-100分）
   - 步骤3：按权重计算总分 = 流动性×0.20 + 风险×0.25 + 收益×0.25 + 溢价×0.15 + 情绪×0.15
   - 步骤4：按总分降序排序，相同分数按风险评分排序（风险越低排名越前）

2. 股票池分配：
   - 稳健仓（5只ETF）：选择风险控制评分 > 75 的前5名
   - 激进仓（5只ETF）：选择风险控制评分 ≤ 75 的前5名

3. 仓位建议：
   - 稳健仓：高评分ETF(85+) 50%，中等评分(70-85) 30%，低评分(<70) 0%
   - 激进仓：高评分ETF(85+) 100%，中等评分(70-85) 50%，低评分(<70) 0%

【评分计算流程】
1. 流动性评分 = (日均成交额评分×0.6 + 规模评分×0.4)
   - 日均成交额评分：min(100, (日均成交额/10)×100)
   - 规模评分：min(100, (规模/500)×100)

2. 风险控制评分 = (波动率评分×0.6 + 最大回撤评分×0.4)
   - 波动率评分：max(0, 100 - 年化波动率×2)
   - 最大回撤评分：max(0, 100 - 最大回撤×2)

3. 收益能力评分 = (1年收益评分×0.3 + 3年收益评分×0.4 + 夏普比率评分×0.3)
   - 1年收益评分：min(100, max(0, 1年收益率×2))
   - 3年收益评分：min(100, max(0, 3年收益率))
   - 夏普比率评分：min(100, max(0, 夏普比率×10))

4. 溢价率评分 = 基础分 + 适度溢价加分
   - 基础分：max(0, 100 - |溢价率|×5)
   - 适度溢价加分：0.5%~1.5%额外+10分，-1%~0%额外+5分

5. 情绪指标评分 = (龙头股占比评分×0.6 + 行业分散度评分×0.4)
   - 龙头股占比评分：min(100, 前5大成分股权重和×150)
   - 行业分散度评分：min(100, 行业数量×10)

【异常处理机制】
1. 数据不足：返回默认中等评分（60分）
2. API调用失败：尝试备用数据源，最多重试3次
3. 无符合标准ETF：使用预设的10只ETF作为备用池
4. 评分异常：设置合理阈值，过滤极端值
