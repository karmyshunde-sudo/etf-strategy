<!DOCTYPE html>
<html>
<head>
  <title>ETF 策略测试触发器</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .container { background: #f5f5f5; padding: 20px; border-radius: 8px; }
    .task { margin-bottom: 15px; padding: 10px; background: white; border: 1px solid #ddd; }
    button { padding: 8px 15px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #0055aa; }
    .status { margin-top: 10px; padding: 5px; }
  </style>
</head>
<body>
  <h1>ETF 策略测试触发器</h1>
  <p>点击以下按钮手动触发测试（无需等待交易日）</p>
  
  <div class="container">
    <div class="task">
      <h3>测试消息推送 (T01)</h3>
      <p>发送测试消息到企业微信，验证消息通道</p>
      <button onclick="triggerTest('test_message')">触发测试</button>
      <div id="test_message_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>测试新股申购信息 (T07)</h3>
      <p>推送当天可申购的新股测试信息</p>
      <button onclick="triggerTest('test_new_stock')">触发测试</button>
      <div id="test_new_stock_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>测试股票池推送 (T04)</h3>
      <p>推送当前有效的ETF股票池</p>
      <button onclick="triggerTest('test_stock_pool')">触发测试</button>
      <div id="test_stock_pool_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>测试策略推送 (T05)</h3>
      <p>执行策略计算并推送买卖信号</p>
      <button onclick="triggerTest('test_execute')">触发测试</button>
      <div id="test_execute_status" class="status"></div>
    </div>
    
    <div class="task">
      <h3>重置所有仓位 (T06)</h3>
      <p>将所有ETF仓位重置为0%</p>
      <button onclick="triggerTest('test_reset')">触发测试</button>
      <div id="test_reset_status" class="status"></div>
    </div>
  </div>
  
  <script>
    function triggerTest(task) {
      const statusDiv = document.getElementById(`${task}_status`);
      statusDiv.textContent = "触发中...";
      statusDiv.style.color = "blue";
      
      // 从URL获取仓库信息
      const url = window.location.pathname;
      const parts = url.split('/');
      const owner = parts[1];
      const repo = parts[2];
      
      if (!owner || !repo) {
        statusDiv.textContent = "无法确定仓库信息，请确保页面部署在正确的路径";
        statusDiv.style.color = "red";
        return;
      }
      
      // 触发GitHub Actions
      fetch(`https://api.github.com/repos/${owner}/${repo}/actions/workflows/schedule.yml/dispatches`, {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': 'Bearer ${TOKEN}',
          'X-GitHub-Api-Version': '2022-11-28'
        },
        body: JSON.stringify({
          ref: 'main',
          inputs: {
            task: task
          }
        })
      })
      .then(response => {
        if (response.ok) {
          statusDiv.textContent = "触发成功！请等待1-2分钟查看结果";
          statusDiv.style.color = "green";
        } else {
          statusDiv.textContent = "触发失败，请检查网络或权限";
          statusDiv.style.color = "red";
        }
      })
      .catch(error => {
        statusDiv.textContent = "网络错误: " + error.message;
        statusDiv.style.color = "red";
      });
    }
  </script>
</body>
</html>
