<!DOCTYPE html>
<html>
<head>
  <title>ETF 策略测试触发器</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ... 样式部分保持不变 ... */
  </style>
</head>
<body>
  <h1>ETF 策略测试触发器</h1>
  <p>点击以下按钮手动触发测试（无需等待交易日）</p>
  
  <div class="container">
    <!-- 测试任务按钮 -->
    <div class="task">
      <h3>测试消息推送 (T01)</h3>
      <p>发送测试消息到企业微信，验证消息通道</p>
      <button onclick="triggerTest('test_message')">触发测试</button>
      <div id="test_message_status" class="status"></div>
      <div id="test_message_debug" class="debug-info"></div>
    </div>
    
    <!-- 其他测试任务按钮保持不变 -->
  </div>
  
  <footer>
    <p>全自动 ETF 投资决策系统 | 纯 GitHub 部署方案</p>
    <p>无需 Google 服务 | 中国大陆可用 | 浏览器测试链接</p>
  </footer>
  
  <script>
    function updateStatus(task, status, className, message, debugInfo = '') {
      // ... 保持原有实现 ...
    }
    
    function getRepositoryInfo() {
      // ... 保持原有实现 ...
    }
    
    function triggerTest(task) {
      updateStatus(task, 'loading', 'loading', '触发中...');
      
      const repoInfo = getRepositoryInfo();
      if (!repoInfo.success) {
        updateStatus(task, 'error', 'error', repoInfo.error);
        return;
      }
      
      const { owner, repo } = repoInfo;
      
      // 检查是否在 GitHub Pages 上
      if (!window.location.hostname.endsWith('.github.io')) {
        updateStatus(task, 'error', 'error', '页面必须部署在 GitHub Pages 上才能工作');
        return;
      }
      
      // 获取 TRI_HTM_TOKEN
      const urlParams = new URLSearchParams(window.location.search);
      const triHtmToken = urlParams.get('TRI_HTM_TOKEN');
      
      if (!triHtmToken) {
        updateStatus(task, 'error', 'error', '缺少安全密钥，请在URL后添加?TRI_HTM_TOKEN=YOUR_TOKEN');
        return;
      }
      
      // 构建请求 URL 和参数
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/api-trigger.yml/dispatches`;
      const requestData = {
        ref: 'main',
        inputs: {
          task: task
        }
      };
      
      // 记录调试信息
      const debugInfo = `请求信息:
- 仓库: ${owner}/${repo}
- API URL: ${apiUrl}
- 请求参数: ${JSON.stringify(requestData, null, 2)}
- 页面 URL: ${window.location.href}
- Hostname: ${window.location.hostname}
- 路径: ${window.location.pathname}
- Token 长度: ${triHtmToken.length} 字符`;

      // 显示调试信息
      updateStatus(task, 'loading', 'loading', '触发中... (查看下方调试信息)', debugInfo);
      
      // 触发 GitHub Actions
      fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Accept': 'application/vnd.github+json',
          'Authorization': `token ${triHtmToken}`,
          'X-GitHub-Api-Version': '2022-11-28'
        },
        body: JSON.stringify(requestData)
      })
      .then(response => {
        const statusText = `HTTP ${response.status} ${response.statusText}`;
        
        return response.text().then(text => {
          try {
            const json = JSON.parse(text);
            return {
              status: response.status,
              statusText: statusText,
              json: json,
              text: text
            };
          } catch (e) {
            return {
              status: response.status,
              statusText: statusText,
              json: null,
              text: text
            };
          }
        });
      })
      .then(result => {
        const debugInfo = `API 响应:
- 状态: ${result.status} ${result.statusText}
- 响应内容: ${result.json ? JSON.stringify(result.json, null, 2) : result.text}`;
        
        if (result.status === 204) {
          updateStatus(task, 'success', 'success', '触发成功！请等待1-2分钟查看结果', debugInfo);
        } else {
          let errorMessage = `触发失败: ${result.statusText}`;
          
          if (result.json && result.json.message) {
            errorMessage += `\n详细错误: ${result.json.message}`;
          } else if (result.text) {
            errorMessage += `\n响应内容: ${result.text.substring(0, 200)}`;
          }
          
          updateStatus(task, 'error', 'error', errorMessage, debugInfo);
        }
      })
      .catch(error => {
        const debugInfo = `网络错误:
- 错误类型: ${error.name}
- 错误消息: ${error.message}
- 堆栈信息: ${error.stack}`;
        
        console.error('网络错误详情:', error);
        updateStatus(task, 'error', 'error', `网络错误: ${error.message}`, debugInfo);
      });
    }
    
    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
      if (window.location.hostname.endsWith('.github.io')) {
        const tokenStatus = document.createElement('div');
        tokenStatus.className = 'status info';
        
        const urlParams = new URLSearchParams(window.location.search);
        const triHtmToken = urlParams.get('TRI_HTM_TOKEN');
        
        if (!triHtmToken) {
          tokenStatus.textContent = '⚠️ 缺少安全密钥 - 请在URL后添加?TRI_HTM_TOKEN=YOUR_TOKEN';
        } else {
          tokenStatus.textContent = `✓ 安全密钥已提供 (长度: ${triHtmToken.length} 字符)`;
        }
        
        document.querySelector('.container').insertBefore(tokenStatus, document.querySelector('.container').firstChild);
        
        const urlHint = document.createElement('div');
        urlHint.className = 'status info';
        urlHint.innerHTML = '使用提示: <br>访问此页面时请添加安全密钥: <br><code>https://karmyshunde-sudo.github.io/etf-strategy/trigger.html?TRI_HTM_TOKEN=YOUR_40_CHAR_TOKEN</code>';
        document.querySelector('.container').insertBefore(urlHint, document.querySelector('.container').firstChild);
      } else {
        const warning = document.createElement('div');
        warning.className = 'status info';
        warning.textContent = '⚠️ 页面应在GitHub Pages上运行才能触发任务';
        document.querySelector('.container').insertBefore(warning, document.querySelector('.container').firstChild);
      }
    });
  </script>
</body>
</html>
