# 项目文件说明书

#####################################################################################################

【25-8-22 Ver3.0】

1、数据源爬取数据，所有的数据我只需要近1年的数据，但你从截图可以看到，代码爬取的是2005年开始。

2、只有保存默认的ETF时才能成功保存csv，其它的爬取数据虽然显示成功保存，但并没有保存在github仓库当中。所以应该详细检查代码，爬取的数据和默认的ETF列表这两者保存数据的目录到底有什么不一样。

1、我要求保存数据的用意就是确保一天只爬取两次数据，一次是交易时间段的数据，一次是下午收盘后日线数据。

2、对于稳健仓、激进仓、套利仓的计算和推送必须是每个交易日只需要成功推送一次，所以在爬取数据前去github仓库当中查阅推送标志，当天已经成功推送的仓位不再计算。

3、已经保存的数据文件不应该是删除旧的文件再保存新的文件，而是应该取出最后保存的日期，再从该日期后开始爬取数据，例如sh.510050_daily.csv保存最后一条数据是2025-08-20，则该股票应该从2025-08-21开始爬取数据。然后逐条写入sh.510050_daily.csv当中。

4、把套利仓的计算定时器改为每交易日早上10点、下午1点各执行一次。

5、其它逻辑不变

1、设置定时器，每天早上9点40分爬取当天数据，包括ETF的交易数据、新股申购、新上市股票信息。

2、每天下午4点定时器爬取日线数据。

3、把新股申购、新上市股票的推送设定在交易日的早上10点30分。

4、所有策略的计算，都不再包含数据爬取。只能从仓库当中提取已经保存的数据，若数据不充分或不完整，必须要有出错信息推送到微信，而不是只保存在日志当中。

综合以上所有修改，代码文件会有大篇幅的修改，你应该把所有代码文件逐一逐一完整地返回给我。

#####################################################################################################

【250820--aciotn检查：cleanup---OK】

【250820晚Ver2.0--数据源一文件一保存，断点续爬修改】



一、config - 配置模块  本文件负责存储所有全局配置参数
  
【策略详细说明 - 配置参数】
1. 数据存储路径：
   - BASE_DIR: 项目基础目录
   - RAW_DATA_DIR: 原始数据存储目录
   - STOCK_POOL_DIR: 股票池存储目录
   - TRADE_LOG_DIR: 交易流水存储目录
   - ERROR_LOG_DIR: 错误日志存储目录
   - NEW_STOCK_DIR: 新股数据存储目录  # 修正：移除"DATA"，与main.py保持一致
   - ARBITRAGE_DIR: 套利数据存储目录

2. 新股信息标记文件：
   - NEW_STOCK_PUSHED_FLAG: 标记新股信息是否已推送
   - LISTING_PUSHED_FLAG: 标记新上市交易股票信息是否已推送
   - ARBITRAGE_STATUS_FILE: 套利状态文件

3. 企业微信配置：
   - WECOM_WEBHOOK: 企业微信机器人webhook地址
   - MESSAGE_FOOTER: 消息底部附加信息

4. 系统参数：
   - CRON_SECRET: 定时任务验证密钥
   - MAX_RETRIES: 最大重试次数
   - RETRY_DELAY: 重试间隔时间(秒)

5. 数据源配置：
   - AKSHARE_TOKEN: AkShare API令牌
   - BAOSTOCK_USER: Baostock用户名
   - BAOSTOCK_PWD: Baostock密码
   - SINA_FINANCE_URL: 新浪财经API基础URL

6. 日志配置：
   - LOG_LEVEL: 日志级别
   - LOG_FILE: 日志文件路径

【修复说明】
1. 修复了NEW_STOCK_DIR属性缺失问题：
   - 将NEW_STOCK_DATA_DIR重命名为NEW_STOCK_DIR，与main.py中的引用保持一致
   - 这是导致cleanup任务失败的根本原因

2. 保持命名风格一致性：
   - 所有数据目录属性现在都采用统一命名风格（没有额外的"DATA"）
   - 例如：RAW_DATA_DIR, STOCK_POOL_DIR, NEW_STOCK_DIR

3. 确保目录初始化正确：
   - 更新了目录初始化列表，使用正确的NEW_STOCK_DIR

【使用说明】
1. 访问配置参数：Config.RAW_DATA_DIR
2. 初始化目录：Config.init_directories()
3. 获取环境变量：os.getenv('VARIABLE_NAME', 'default')

二、main.py - 主入口文件 ，负责执行所有策略和处理所有请求

【数据爬取模块说明】
  本文件同时负责从多个数据源获取ETF数据和新股信息
  主数据源：AkShare
  备用数据源：Baostock、新浪财经

【策略详细说明 - 数据获取逻辑】
1. ETF数据获取流程：
   - 主数据源：AkShare（优先尝试，返回最完整数据）
   - 备用数据源1：Baostock（当AkShare失败时尝试）
   - 备用数据源2：新浪财经（当前两个数据源都失败时尝试）
   - 缓存机制：优先检查本地缓存，减少API调用次数

2. 新股信息获取逻辑：
   - 区分两种新股类型：
     * 认购新股（IPO申购）：通过"网上申购日"筛选
     * 上市交易新股：通过"上市日期"筛选
   - 历史数据范围：过去30天（原为7天），确保覆盖最近上市交易的新股
   - 多数据源回退机制：确保即使主数据源失败也能获取数据

3. 数据质量保障：
   - 严格的数据验证：检查DataFrame是否为空
   - 完善的错误处理：记录详细错误日志
   - 数据类型转换：确保数值型字段为正确类型
   - 日期格式标准化：统一使用YYYY-MM-DD格式

4. 性能优化：
   - 缓存机制：减少重复API调用
   - 限流控制：每个API调用间隔1秒
   - 数据过滤：仅获取必要字段

【异常处理机制】
1. 数据源失败：
   - 记录详细错误日志，包含错误类型和消息
   - 自动切换到备用数据源
   - 所有数据源失败时返回空DataFrame

2. 数据质量异常：
   - 空数据处理：返回空DataFrame而非抛出异常
   - 字段缺失处理：使用默认值填充
   - 类型转换错误：记录日志并跳过该条数据

3. 网络问题：
   - 设置15秒超时
   - 重试机制（最多3次）
   - 失败后等待30分钟再重试

【使用说明】
1. 获取ETF数据：get_etf_data(etf_code, data_type='daily')
2. 获取ETF列表：get_all_etf_list()
3. 获取新股信息：get_new_stock_subscriptions()
4. 测试用新股数据获取：get_test_new_stock_subscriptions()
5. 测试用新上市股数据获取：get_test_new_stock_listings()

【数据存储模块说明】
  本文件同时负责数据的存储和清理
  所有文件放在根目录，简化导入关系

【时间处理工具说明】
  本文件同时提供时间相关的工具函数
  所有文件放在根目录，简化导入关系

【企业微信集成说明】
  本文件同时处理企业微信消息推送
  所有文件放在根目录，简化导入关系

【股票池管理模块说明】
  本文件同时负责ETF股票池的更新和管理
  保持10只ETF：5只稳健仓，5只激进仓
  所有文件放在根目录，简化导入关系

【策略计算模块说明】
  本文件负责ETF策略信号的计算和推送
  所有文件放在根目录，简化导入关系

【评分系统核心模块】
  本文件同时包含ETF评分计算功能，为其他模块提供统一的评分接口
  所有文件放在根目录，简化导入关系

【策略详细说明 - 评分体系】
1. 评分维度与权重分配：
   - 流动性评分（20%）：评估ETF交易活跃度，由日均成交额和规模决定
     * 日均成交额（12%）：越高分越高，10亿以上得满分
     * 规模（8%）：越大分越高，500亿以上得满分
     * 目的：确保ETF有足够流动性，避免买卖困难

2. 风险控制评分（25%）：评估ETF风险水平，由波动率和最大回撤决定
   - 年化波动率（15%）：越低分越高，<15%得满分
   - 最大回撤（10%）：越小分越高，<20%得满分
   * 目的：稳健仓特别关注风险控制，避免大幅波动

3. 收益能力评分（25%）：评估ETF历史收益表现
   - 1年收益率（10%）：越高分越高，>10%得满分
   - 3年年化收益率（10%）：越高分越高，>8%得满分
   - 夏普比率（5%）：越高分越高，>1.0得满分
   * 目的：衡量风险调整后收益，避免高风险高收益

4. 溢价率评分（15%）：评估ETF市场价格与净值关系
   - 溢价率（10%）：越接近0%越好，-1%~1%得满分
   - 适度溢价加分（5%）：0.5%~1.5%额外加分
   * 目的：避免在高溢价时买入，防止套利压力

5. 情绪指标评分（15%）：评估市场情绪和成分股质量
   - 龙头股占比（9%）：前5大成分股权重和，越高分越高
   - 行业分散度（6%）：行业数量越多分越高，避免过度集中
   * 目的：捕捉市场情绪和行业轮动机会

【股票池构建逻辑】
1. 筛选过程：
   - 步骤1：获取所有ETF列表（约50只）
   - 步骤2：计算每只ETF的5个维度评分（0-100分）
   - 步骤3：按权重计算总分 = 流动性×0.20 + 风险×0.25 + 收益×0.25 + 溢价×0.15 + 情绪×0.15
   - 步骤4：按总分降序排序，相同分数按风险评分排序（风险越低排名越前）

2. 股票池分配：
   - 稳健仓（5只ETF）：选择风险控制评分 > 75 的前5名
   - 激进仓（5只ETF）：选择风险控制评分 ≤ 75 的前5名

3. 仓位建议：
   - 稳健仓：高评分ETF(85+) 50%，中等评分(70-85) 30%，低评分(<70) 0%
   - 激进仓：高评分ETF(85+) 100%，中等评分(70-85) 50%，低评分(<70) 0%

【评分计算流程】
1. 流动性评分 = (日均成交额评分×0.6 + 规模评分×0.4)
   - 日均成交额评分：min(100, (日均成交额/10)×100)
   - 规模评分：min(100, (规模/500)×100)

2. 风险控制评分 = (波动率评分×0.6 + 最大回撤评分×0.4)
   - 波动率评分：max(0, 100 - 年化波动率×2)
   - 最大回撤评分：max(0, 100 - 最大回撤×2)

3. 收益能力评分 = (1年收益评分×0.3 + 3年收益评分×0.4 + 夏普比率评分×0.3)
   - 1年收益评分：min(100, max(0, 1年收益率×2))
   - 3年收益评分：min(100, max(0, 3年收益率))
   - 夏普比率评分：min(100, max(0, 夏普比率×10))

4. 溢价率评分 = 基础分 + 适度溢价加分
   - 基础分：max(0, 100 - |溢价率|×5)
   - 适度溢价加分：0.5%~1.5%额外+10分，-1%~0%额外+5分

5. 情绪指标评分 = (龙头股占比评分×0.6 + 行业分散度评分×0.4)
   - 龙头股占比评分：min(100, 前5大成分股权重和×150)
   - 行业分散度评分：min(100, 行业数量×10)

【异常处理机制】
1. 数据不足：返回默认中等评分（60分）
2. API调用失败：尝试备用数据源，最多重试3次
3. 无符合标准ETF：使用预设的10只ETF作为备用池
4. 评分异常：设置合理阈值，过滤极端值
